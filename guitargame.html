<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SyncFiddle</title>
</head>  
 
<body>
  
  
  <canvas id="canvasMenu" style="display:block; position:absolute; left:50%; transform:translate(-50%, 0); background-color:lightgray;"></canvas>
  <canvas id="canvasGame" style="display:none;  position:absolute; left:50%; transform:translate(-50%, 0); background-color:lightgray;"></canvas>
  
  <script>
    
    /// Get the html tag canvas.
    var canvasMenu = document.getElementById("canvasMenu");
    var contextMenu = canvasMenu.getContext("2d");

    var canvasGame = document.getElementById("canvasGame");
    var contextGame = canvasGame.getContext("2d"); /// We'll draw on this.
    var gameIsPaused = false;

    var canvasWidth = 600; var canvasHeight = 400;

    /// Variables to keep the animations consistent.
    var lastTime = Date.now();
    var deltaTime = 0;

    var audio = new Audio("gameMusic3.mp3");
    //audio.play();

    var backgroundImg = new Image();
    backgroundImg.src = "http://freedesignfile.com/upload/2016/10/Watercolor-Backgrounds-05.jpg";
    
    /// When the page is done loading, create the canvas and begin gameLoop.
    window.onload = function() {
      /// Game window size in pixels
      canvasMenu.width = canvasWidth;
      canvasMenu.height = canvasHeight;
      
      /// Game window size in pixels
      canvasGame.width = canvasWidth;
      canvasGame.height = canvasHeight;

      SceneController.menuLoop();
    }

    /// Menu buttons
    function menuButtons(x, y, width, height, txt, func) {
      this.x = x;
      this.y = y;
      this.width = width;
      this.height = height;
      this.txt = txt;
      this.func = func;
      this.col = "black";
      this.update = function() {
        this.draw();
        /// If mouse is over the button
        if (mouseX > this.x && mouseX < (this.x+this.width) && mouseY > this.y && mouseY < (this.y+this.height)) {
          this.col = "gray";
          if (Mouse.leftClick) {
            this["func"]();
          }
        } else {
          this.col = "black";
        }
      };
      this.draw = function() {
        contextMenu.fillStyle = this.col;
        contextMenu.fillRect(this.x, this.y, this.width, this.height);
        contextMenu.fillStyle = "white";
        contextMenu.font = "18px Arial";
        contextMenu.textAlign = "center";
        contextMenu.textBaseline = "middle";
        contextMenu.fillText(this.txt, this.x+this.width/2, this.y+this.height/2);
        contextMenu.textAlign = "left";
        contextMenu.textBaseline = "alphabetic";
      }
    }

    /// Menu Buttons Start
    var menuBtnStart = new menuButtons(20, 200, 100, 25, "Start", function(){
      currentScene = SceneController.gameLoop;
      canvasMenu.style["display"] = "none";
      canvasGame.style["display"] = "block";
      audio.play();
      SceneController.gameLoop();
    });
    /// Menu Buttons End


    /// Scene Controller
    var SceneController = {
      menuLoop : function() {
        requestAnimationFrame(currentScene);
        SceneController.menuDraw();

        /// Keeping the animations consistent.
        var nowTime = Date.now();
        deltaTime = (nowTime - lastTime) / 1000;
        lastTime = nowTime;

        /// Menu button
        menuBtnStart.update();

        /// Mouse events
        MouseEvents();

      },

      menuDraw : function() {
        contextMenu.clearRect(0, 0, canvasWidth, canvasHeight);

        debugStats(contextMenu);
      },

      gameLoop : function() {
        requestAnimationFrame(currentScene);
        SceneController.gameDraw();

        /// Keeping the animations consistent.
        var nowTime = Date.now();
        deltaTime = (nowTime - lastTime) / 1000;
        lastTime = nowTime;

        /// Keyboard events
        KeyboardEvents();

        //BlockStrip.update();

        /// Update each Letter Block object.
        for (var i=0; i<LetterBlockObjects.length; i++){
          var lbo = LetterBlockObjects[i];
          lbo.update();

          /// Check for BlockStrip collision.
          if (BlockStrip.collision(lbo.y, lbo.height)) {
            if (Keyboard.CurrentKey === lbo.letter.charCodeAt(0)-65) {
              LetterBlockObjects.splice(i, 1);

              GameController.score += 100;
              GameController.scoreScale = 2;
              
              //console.log(Keyboard.CurrentKey);
            }
          }
          
          /// Destroy itself when it is off screen.
          if (lbo.y >= canvasHeight) {
            LetterBlockObjects.splice(i, 1);
            GameController.screenShakeTime = 0.2;
            if (GameController.score > 0) GameController.score -= 50;
          }
        }


        /// Update Music Time Stamp
        GameController.update();

      },

      gameDraw : function() {
        contextGame.clearRect(0, 0, canvasWidth, canvasHeight);

        contextGame.drawImage(backgroundImg, 0+GameController.screenShakeX, 0+GameController.screenShakeY);

        BlockStrip.draw();



        contextGame.textAlign = "center";
        contextGame.textBaseline = "middle";
        contextGame.fillStyle = "rgba(255, 255, 255, 0.3)";
        contextGame.font =  (72 * GameController.scoreScale) + "px Calibri";
        contextGame.fillText(GameController.score.toLocaleString(), canvasWidth/2+GameController.screenShakeX, canvasHeight/2+GameController.screenShakeY);
        contextGame.textBaseline = "alphabetic";
        contextGame.fillStyle = "rgba(255, 255, 255, 1)";

        for (var i=0; i<LetterBlockObjects.length; i++) {
          var lbo = LetterBlockObjects[i];
          lbo.draw();
        }

        if (gameIsPaused) {
          contextGame.fillStyle = "rgba(0, 0, 0, 0.8)";
          contextGame.fillRect(0, 0, canvasWidth, canvasHeight);
          contextGame.fillStyle = "rgba(255, 255, 255, 1)";

          contextGame.fillStyle = "#fff";
          contextGame.textAlign = "center";
          contextGame.font = "38px Arial";
          contextGame.fillText("Game Paused", canvasWidth/2, canvasHeight/2);
          contextGame.font = "24px Calibri";
          contextGame.fillText("press 'ESC' to resume.", canvasWidth/2, canvasHeight/2+40);
          contextGame.textAlign = "left";
        }

        debugStats(contextGame);
      }
    }
    var currentScene = SceneController.menuLoop;
    
    
    /// Game controller
    var GameController = {
      score : 0,
      scoreScale : 1,
      scoreScaleSpeed : 7,

      /// Music
      currentMusicTimestamp : 0,

      /// Screen shake
      screenShakeX : 0,
      screenShakeY : 0,
      screenShakeTime : 0.0, /// Set time to 0.5s

      //difficulty : 1, /// Speed * difficulty.
      //randomBlockSpawnTime : parseInt(Math.random() * 3000),

      update : function() {

        if (gameIsPaused) return;
        
        if (this.scoreScale > 1) this.scoreScale -= this.scoreScaleSpeed * deltaTime; else this.scoreScale = 1;

        this.currentMusicTimestamp += 1 * deltaTime;

        /// Screen shake.
        if (this.screenShakeTime > 0) {
          this.screenShakeTime -= 1 * deltaTime;
          this.screenShakeX = (Math.random() * 8);
          this.screenShakeX *= Math.floor(Math.random() * 2) == 1 ? 1:-1;
          this.screenShakeY = Math.random() * 8 
          this.screenShakeY *= Math.floor(Math.random() * 2) == 1 ? 1:-1;

        } else if (this.screenShakeTime <= 0) {
          this.screenShakeTime = 0;
          this.screenShakeX = 0;
          this.screenShakeY = 0;
        }

        /// Music time stamp.
        if (musicTime[musicTimeIndex][1] === false) {
          if (GameController.currentMusicTimestamp >= musicTime[musicTimeIndex][0]) {
            LetterBlockObjects.push(cLB());
            musicTime[musicTimeIndex][1] = true;
            if (musicTimeIndex != musicTime.length-1) musicTimeIndex ++;
          }
        }

        /*
        this.scoreAnimate();
        this.musicUpdate();
        */

      },

      scoreAnimate : function() {
        if (this.scoreScale > 1) this.scoreScale -= this.scoreScaleSpeed * deltaTime; else this.scoreScale = 1;
      },

      musicUpdate : function() {
        this.currentMusicTimestamp += 1 * deltaTime;
      }

    }
    
    
    /// Objects
    //var randomBlockSpawnTime = parseInt(Math.random() * 3000); /// Random time of 1-5 seconds
    var LetterBlockObjects = [];
    var Letters = ["A", "B", "C", "D", "E", "F", "G",
                   "H", "I", "J", "K", "L", "M", "N",
                   "O", "P", "Q", "R", "S", "T", "U",
                   "V", "W", "X", "Y", "Z"];
    /// Keyboard object
    var Keyboard = {
      CurrentKey : -1,
      Keys : [],
      KeyEscape : false
    }
    /// Poopulate the Keyboard's Key array.
    for (var i=0; i<26; i++) {
      Keyboard.Keys.push(false);
    }

    var Mouse = {
      leftClick : false
    }
    var mouseX = 0; mouseY = 0;
    
    
    /// The will be called every step of the game.
    function KeyboardEvents() {
        window.onkeydown = function(e) {
          switch(e.keyCode) {
            /// Escape key
            case 27 :
              Keyboard.CurrentKey = e.keyCode;
              //Keyboard.KeyEscape = true;
              if (gameIsPaused) {
                gameIsPaused = false;
                audio.play();
              } else  {
                gameIsPaused = true;
                audio.pause();
              }
              break;

            /// Normal letters
            default : 
              Keyboard.CurrentKey = e.keyCode-65;
              Keyboard.Keys[e.keyCode-65] = true;
              /// Animate the BlockStrip's colour.
              BlockStrip.col = "green";
              break;
          }
          
        }
        
        window.onkeyup = function(e) {
          switch(e.keyCode) {
            /// Escape
            case 27 :
              //Keyboard.KeyEscape = false;
              break;

            /// Letter Keys
            default :
              Keyboard.Keys[e.keyCode-65] = false;
              BlockStrip.col = "white";
              break;
          }
          Keyboard.CurrentKey = -1;
        }
    }

    /// Get mouse position.
    window.onmousemove = function(e) {
      var rect = canvasMenu.getBoundingClientRect();
      mouseX = (e.clientX - rect.left);
      mouseY = (e.clientY - rect.top);
    }
    /// Mouse events
    function MouseEvents() {
      window.onmousedown = function(e) {
        if (e.button === 0) Mouse.leftClick = true;
        window.onmousedown = function() {
          if (e.button === 0) Mouse.leftClick = false;
        }
      }
      Mouse.leftClick = false;
    }
    
    
    
    /// Letter block constructor.
    function LetterBlock(x, y, speed, letter) {
      this.x = x;
      this.y = y;
      this.width = 50;
      this.height = 50;
      this.speed = speed;
      this.letter = letter;

      /// 2.76 seconds
      
      this.update = function(){
        if (gameIsPaused) return;

        /// Where the code for every step goes.
        
        this.y += this.speed * deltaTime;        
      }
      
      this.draw = function(){
        /// Draw self
        contextGame.fillStyle = "blue";
        contextGame.fillRect(this.x, this.y, this.width + GameController.screenShakeX, this.height + GameController.screenShakeY);
        contextGame.font = "32px Arial";
        contextGame.fillStyle = "black";
        contextGame.textAlign = "center";
        contextGame.fillText(this.letter, this.x + 25 + GameController.screenShakeX, this.y + 36 + GameController.screenShakeY);
        contextGame.textAlign = "left";
      }
    }
    
    
    
    /// BlockStrip object (where the LetterBlocks must be to be destroyed)
    /// The dimensions are 600px x 50px
    
    var BlockStrip = {
      x : 0,
      y : 400-100,//canvas.height - 100,
      width : canvasWidth*2,
      height : 15,
      col : "white",
      
      update : function() {
        ///this.draw();
      },
        
      draw : function() {
        contextGame.fillStyle = this.col;
        contextGame.fillRect(this.x, this.y, this.width + GameController.screenShakeX, this.height + GameController.screenShakeY);
      },

      collision : function(otherY, otherHeight) {
        //if (otherY < this.y+this.height && otherY > this.y || otherY+otherHeight > this.y && otherY+otherHeight < this.y+this.height) {
          //console.log("true");
        if (otherY+otherHeight < this.y || otherY > this.y+this.height) {
          return false;
        } else {
          return true;
        }
      }
    } 
    
    
    function debugStats(context) {
      context.fillStyle = "white";
      context.font = "12px calibri";
      context.textAlign = "left";
      context.fillText("deltaTime : " + deltaTime, 5, 10);
      //context.fillText("randomBlockSpawnTime : " + GameController.randomBlockSpawnTime + "ms", 5, 20);
      context.fillText("mousePosition : " + mouseX + "," + mouseY, 5, 30);
      context.fillText("MouseLMB : " + Mouse.leftClick, 5, 40);
      context.fillText("currentMusicTimestamp : " + GameController.currentMusicTimestamp, 5, 50);
      context.fillText("musicTime : [" + musicTime[musicTimeIndex][0] + "][" + musicTime[musicTimeIndex][1] + "]", 5, 60);
      context.fillText("shakeTime : " + GameController.screenShakeTime, 5, 70);
      context.fillText("shakeX, shakeY : " + GameController.screenShakeX + "," + GameController.screenShakeY, 5, 80);
      context.fillText("gameIsPaused : " + gameIsPaused, 5, 90);
      //for (var i=0; i<26; i++)
      //contextGame.fillText(Letters[i] + " : " + Keyboard.Keys[i], 5, 40 + i * 10);
    }
    
    
    
    
  </script>
  <script src="guitargamemusic.js"></script>
</body>
</html>