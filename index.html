<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SyncFiddle</title>
</head>  
 
<body>
  
  
  <canvas id="canvasMenu" style="display:block; position:absolute; left:50%; transform:translate(-50%, 0); background-color:lightgray;"></canvas>
  <canvas id="canvasGame" style="display:none;  position:absolute; left:50%; transform:translate(-50%, 0); background-color:lightgray;"></canvas>
  
  <script>

    function complete() {
      GameController.currentMusicTimestamp = 169.22;
      audio.currentTime = 169.22;
      setTimeout(function(){LetterBlockObjects = []}, 300);
      //GameController.currentMusicTimestamp = 158;
    }

    function fast() {
      GameController.currentMusicTimestamp = 46;
      audio.currentTime = 46;
      setTimeout(function(){LetterBlockObjects = []}, 300);
    }
    
    /// Get the html tag canvas.
    var canvasMenu = document.getElementById("canvasMenu");
    var contextMenu = canvasMenu.getContext("2d");

    var canvasGame = document.getElementById("canvasGame");
    var contextGame = canvasGame.getContext("2d"); /// We'll draw on this.
    var gameIsPaused = false;

    var canvasWidth = 600; var canvasHeight = 400;

    /// Variables to keep the animations consistent.
    var lastTime = Date.now();
    var deltaTime = 0;

    var menuAudio = new Audio("Assets/Music/menuMusic.mp3");
    menuAudio.loop = true;
    menuAudio.play();
    var audio = new Audio("Assets/Music/music.mp3");
    //audio.play();

    var menuBackground = new Image();
    menuBackground.src = "Assets/MenuBackground.png";

    var backgroundImg = new Image();
    backgroundImg.src = "http://freedesignfile.com/upload/2016/10/Watercolor-Backgrounds-05.jpg";
    
    /// When the page is done loading, create the canvas and begin gameLoop.
    window.onload = function() {
      /// Game window size in pixels
      canvasMenu.width = canvasWidth;
      canvasMenu.height = canvasHeight;
      contextMenu.drawImage(menuBackground, 0, 0);
      
      /// Game window size in pixels
      canvasGame.width = canvasWidth;
      canvasGame.height = canvasHeight;

      SceneController.menuLoop();
    }

    /// Menu buttons
    function Buttons(x, y, width, height, txt, ctx, func) {
      this.x = x;
      this.y = y;
      this.width = width;
      this.height = height;
      this.txt = txt;
      this.ctx = ctx;
      this.func = func;
      this.col = "black";
      this.update = function() {
        this.draw();
        /// If mouse is over the button
        if (mouseX > this.x && mouseX < (this.x+this.width) && mouseY > this.y && mouseY < (this.y+this.height)) {
          this.col = "gray";
          if (Mouse.leftClick) {
            /// Call its func.
            this["func"]();
          }
        } else {
          this.col = "black";
        }
      };
      this.draw = function() {
        this.ctx.fillStyle = "rgba(255, 255, 255, 1)";
        this.ctx.fillStyle = this.col;
        this.ctx.fillRect(this.x, this.y, this.width, this.height);
        this.ctx.fillStyle = "white";
        this.ctx.font = "18px Arial";
        this.ctx.textAlign = "center";
        this.ctx.textBaseline = "middle";
        this.ctx.fillText(this.txt, this.x+this.width/2, this.y+this.height/2);
        this.ctx.textAlign = "left";
        this.ctx.textBaseline = "alphabetic";
      }
    }

    /// Menu Buttons Start
    var menuBtnStart = new Buttons(50, 200, 100, 25, "Start", contextMenu, function(){
      currentScene = SceneController.gameLoop;
      canvasMenu.style["display"] = "none";
      canvasGame.style["display"] = "block";
      menuAudio.pause();
      audio.play();
      SceneController.gameLoop();
    });

    var gameBtnRestart = new Buttons(canvasWidth/2-50, canvasHeight-100, 100, 25, "Restart", contextGame, function(){
      for (var i=0; i<musicTime.length; i++) {
        musicTime[i][1] = false;
      }
      musicTimeIndex = 0;
      LetterBlockObjects = [];
      audio.load();
      audio.play();
      GameController.score = 0;
      GameController.misses = 0;
      GameController.currentMusicTimestamp = 0;
    });
    /// Menu Buttons End

    /// Progression bar
    var ProgressBar = {
      width : 200,
      height : 15,
      x : canvasWidth/2 - 100,
      y : canvasHeight - 30,
      draw : function() {
        /// Draw the background bar
        contextGame.fillStyle = "rgba(0, 0, 0, 0.5)";
        contextGame.fillRect(this.x + GameController.screenShakeX, this.y + GameController.screenShakeY, this.width, this.height);

        /// Draw the progression bar
        contextGame.fillStyle = "rgba(255, 255, 255, 1)";
        contextGame.fillRect(this.x + GameController.screenShakeX, this.y + GameController.screenShakeY, this.width * (audio.currentTime / 169.22), this.height);

        /// Text
        contextGame.font = "12px Arial";
        contextGame.textAlign = "center";
        contextGame.fillStyle = "rgba(255, 255, 255, 1)";
        if (Math.floor(audio.currentTime % 60) > 9)
          contextGame.fillText(Math.floor(audio.currentTime/60) + ":" + Math.floor(audio.currentTime % 60), (this.x + GameController.screenShakeX) + Math.floor(this.width * (audio.currentTime / 169.22)), this.y-2);
        else 
          contextGame.fillText(Math.floor(audio.currentTime/60) + ":0" + Math.floor(audio.currentTime % 60), (this.x + GameController.screenShakeY) + Math.floor(this.width * (audio.currentTime / 169.22)), this.y-2);
      }
    }
    /// End of progression bar

    /// Scene Controller
    var SceneController = {
      menuLoop : function() {
        requestAnimationFrame(currentScene);
        SceneController.menuDraw();

        /// Keeping the animations consistent.
        var nowTime = Date.now();
        deltaTime = (nowTime - lastTime) / 1000;
        lastTime = nowTime;

        /// Menu button
        menuBtnStart.update();

        /// Mouse events
        MouseEvents();

      },

      menuDraw : function() {
        contextMenu.clearRect(0, 0, canvasWidth, canvasHeight);

        contextMenu.drawImage(menuBackground, 0, 0);

        //debugStats(contextMenu);
      },

      gameLoop : function() {
        requestAnimationFrame(currentScene);
        SceneController.gameDraw();

        /// Keeping the animations consistent.
        var nowTime = Date.now();
        deltaTime = (nowTime - lastTime) / 1000;
        lastTime = nowTime;

        /// Keyboard events
        KeyboardEvents();

        //BlockStrip.update();

        /// Update each Letter Block object.
        for (var i=0; i<LetterBlockObjects.length; i++){
          var lbo = LetterBlockObjects[i];
          lbo.update();

          /// Check for BlockStrip collision.
          if (BlockStrip.collision(lbo.y, lbo.height)) {
            if (Keyboard.CurrentKey === lbo.letter.charCodeAt(0)-65) {
              LetterBlockObjects.splice(i, 1);

              if (BlockStrip.collision(lbo.y+lbo.height/2,0)) {
                GameController.score += 100;
                ScoreIndicatorObjects.push(new ScoreIndicator(lbo.x+lbo.width/2, lbo.y, "Perfect"));
              } else {
                GameController.score += 50;
                ScoreIndicatorObjects.push(new ScoreIndicator(lbo.x+lbo.width/2, lbo.y, "Good"));
              }
              GameController.scoreScale = 2;
              
              //console.log(Keyboard.CurrentKey);
            }
          }
          
          /// Destroy itself when it is off screen.
          if (lbo.y >= canvasHeight) {
            LetterBlockObjects.splice(i, 1);
            GameController.screenShakeTime = 0.2;
            GameController.misses ++;
            if (GameController.score > 0) GameController.score -= 50;
          }
        }

        for (var i=0; i<ScoreIndicatorObjects.length; i++) {
          var sco = ScoreIndicatorObjects[i];
          sco.update();
          if (sco.lifeTime <= 0) {
            ScoreIndicatorObjects.splice(i, 1);
          }
        }


        /// Update Music Time Stamp
        GameController.update();

        if (audio.ended) gameBtnRestart.update();

        MouseEvents();

      },

      gameDraw : function() {
        contextGame.clearRect(0, 0, canvasWidth, canvasHeight);

        contextGame.drawImage(backgroundImg, 0+GameController.screenShakeX, 0+GameController.screenShakeY);

        BlockStrip.draw();

        

        contextGame.textAlign = "center";
        contextGame.textBaseline = "middle";
        contextGame.fillStyle = "rgba(255, 255, 255, 0.3)";
        contextGame.font =  (72 * GameController.scoreScale) + "px Calibri";
        contextGame.fillText(GameController.score.toLocaleString(), canvasWidth/2+GameController.screenShakeX, canvasHeight/2+GameController.screenShakeY);
        contextGame.textBaseline = "alphabetic";
        contextGame.fillStyle = "rgba(255, 255, 255, 1)";

        for (var i=0; i<LetterBlockObjects.length; i++) {
          var lbo = LetterBlockObjects[i];
          lbo.draw();
        }

        for (var i=0; i<ScoreIndicatorObjects.length; i++) {
          var sco = ScoreIndicatorObjects[i];
          sco.draw();
        }

        ProgressBar.draw();

        if (gameIsPaused) {
          contextGame.fillStyle = "rgba(0, 0, 0, 0.8)";
          contextGame.fillRect(0, 0, canvasWidth, canvasHeight);
          //contextGame.fillStyle = "rgba(255, 255, 255, 1)";

          contextGame.fillStyle = "#fff";
          contextGame.textAlign = "center";
          contextGame.font = "38px Arial";
          contextGame.fillText("Game Paused", canvasWidth/2, canvasHeight/2);
          contextGame.font = "24px Calibri";
          contextGame.fillText("press 'ESC' to resume.", canvasWidth/2, canvasHeight/2+40);
          contextGame.textAlign = "left";
        }

        if (audio.ended) {
          contextGame.fillStyle = "rgba(0, 0, 0, 0.8)";
          contextGame.fillRect(0, 0, canvasWidth, canvasHeight);
          
          contextGame.fillStyle = "rgba(255, 255, 255, 1)";
          contextGame.font = "32px Arial"
          contextGame.textAlign = "center";
          contextGame.fillText("Song completed!", canvasWidth/2, canvasHeight/2);
          contextGame.textAlign = "left";
          contextGame.font = "18px Arial";
          contextGame.fillText("Score = " + GameController.score, 50, canvasHeight/2+30);
          contextGame.fillText("Matches = " + (musicTime.length - GameController.misses) + "/" + musicTime.length, 50, canvasHeight/2+50);
        }

        contextGame.textAlign="left";
        contextGame.fillStyle="#fff";
        contextGame.font="16px Calibri";
        contextGame.fillText("[ESC] to pause game", 10, 20);

        //ProgressBar.draw();

        //debugStats(contextGame);
      }
    }
    var currentScene = SceneController.menuLoop;
    
    
    /// Game controller
    var GameController = {
      score : 0,
      scoreScale : 1,
      scoreScaleSpeed : 7,

      /// Misses
      misses : 0,

      /// Music
      currentMusicTimestamp : 0,

      /// Screen shake
      screenShakeX : 0,
      screenShakeY : 0,
      screenShakeTime : 0.0, /// Set time to 0.5s

      //difficulty : 1, /// Speed * difficulty.
      //randomBlockSpawnTime : parseInt(Math.random() * 3000),

      update : function() {

        if (gameIsPaused) return;
        
        if (this.scoreScale > 1) this.scoreScale -= this.scoreScaleSpeed * deltaTime; else this.scoreScale = 1;

        

        /// Screen shake.
        if (this.screenShakeTime > 0) {
          this.screenShakeTime -= 1 * deltaTime;
          this.screenShakeX = (Math.random() * 8);
          this.screenShakeX *= Math.floor(Math.random() * 2) == 1 ? 1:-1;
          this.screenShakeY = Math.random() * 8 
          this.screenShakeY *= Math.floor(Math.random() * 2) == 1 ? 1:-1;

        } else if (this.screenShakeTime <= 0) {
          this.screenShakeTime = 0;
          this.screenShakeX = 0;
          this.screenShakeY = 0;
        }

        if (audio.ended) return;
        this.currentMusicTimestamp += 1 * deltaTime;

        /// Music time stamp.
        if (musicTime[musicTimeIndex][1] === false) {
          if (GameController.currentMusicTimestamp >= musicTime[musicTimeIndex][0]) {
            LetterBlockObjects.push(cLB());
            musicTime[musicTimeIndex][1] = true;
            if (musicTimeIndex != musicTime.length-1) musicTimeIndex ++;
          }
        }

        /*
        this.scoreAnimate();
        this.musicUpdate();
        */

      },

      scoreAnimate : function() {
        if (this.scoreScale > 1) this.scoreScale -= this.scoreScaleSpeed * deltaTime; else this.scoreScale = 1;
      },

      musicUpdate : function() {
        this.currentMusicTimestamp += 1 * deltaTime;
      }

    }
    
    
    /// Objects
    //var randomBlockSpawnTime = parseInt(Math.random() * 3000); /// Random time of 1-5 seconds
    var LetterBlockObjects = [];
    var ScoreIndicatorObjects = [];
    var Letters = ["A", "B", "C", "D", "E", "F", "G",
                   "H", "I", "J", "K", "L", "M", "N",
                   "O", "P", "Q", "R", "S", "T", "U",
                   "V", "W", "X", "Y", "Z"];
    /// Keyboard object
    var Keyboard = {
      CurrentKey : -1,
      Keys : [],
      KeyEscape : false
    }
    /// Poopulate the Keyboard's Key array.
    for (var i=0; i<26; i++) {
      Keyboard.Keys.push(false);
    }

    var Mouse = {
      leftClick : false
    }
    var mouseX = 0; mouseY = 0;
    
    
    /// The will be called every step of the game.
    function KeyboardEvents() {
        window.onkeydown = function(e) {
          switch(e.keyCode) {
            /// Escape key
            case 27 :
              Keyboard.CurrentKey = e.keyCode;
              //Keyboard.KeyEscape = true;
              if (gameIsPaused) {
                gameIsPaused = false;
                audio.play();
              } else  {
                gameIsPaused = true;
                audio.pause();
              }
              break;

            /// Normal letters
            default : 
              Keyboard.CurrentKey = e.keyCode-65;
              Keyboard.Keys[e.keyCode-65] = true;
              /// Animate the BlockStrip's colour.
              BlockStrip.col = "green";
              break;
          }
          
        }
        
        window.onkeyup = function(e) {
          switch(e.keyCode) {
            /// Escape
            case 27 :
              //Keyboard.KeyEscape = false;
              break;

            /// Letter Keys
            default :
              Keyboard.Keys[e.keyCode-65] = false;
              BlockStrip.col = "white";
              break;
          }
          Keyboard.CurrentKey = -1;
        }
    }

    /// Get mouse position.
    window.onmousemove = function(e) {
      /*
      var rect = contextMenu.getBoundingClientRect();
      mouseX = (e.clientX - rect.left);
      mouseY = (e.clientY - rect.top);
      */
      /// The 8s are the margin size.
      mouseX = e.clientX - (document.body.clientWidth/2 - canvasWidth/2 + 8);
      mouseY = e.clientY - 8;
    }
    /// Mouse events
    function MouseEvents() {
      window.onmousedown = function(e) {
        if (e.button === 0) Mouse.leftClick = true;
        window.onmousedown = function() {
          if (e.button === 0) Mouse.leftClick = false;
        }
      }
      Mouse.leftClick = false;
    }
    

    /// Score Indicator (i.e Perfect, Good)
    function ScoreIndicator(x, y, txt){
      this.x = x;
      this.y = y;
      this.txt = txt;

      this.lifeTime = 0.4;

      this.update = function(){
        this.lifeTime -= 1*deltaTime;
      }
      this.draw = function() {
        if (this.txt === "Perfect") contextGame.fillStyle="gold"; else contextGame.fillStyle="lime";
        contextGame.textAlign="center";
        contextGame.font="bold 24px Calibri"
        contextGame.fillText(txt, x, y);
        contextGame.font="20px Arial";
        contextGame.textAlign="left";
      }
    }
    
    
    /// Letter block constructor.
    function LetterBlock(x, y, speed, letter) {
      this.x = x;
      this.y = y;
      this.width = 50;
      this.height = 50;
      this.speed = speed;
      this.letter = letter;

      /// 2.76 seconds
      
      this.update = function(){
        if (gameIsPaused) return;

        /// Where the code for every step goes.
        
        this.y += this.speed * deltaTime;        
      }
      
      this.draw = function(){
        /// Draw self
        if (GameController.currentMusicTimestamp >= 0)
          contextGame.fillStyle = "#26ff3f";
        if (GameController.currentMusicTimestamp >= 64.3)
          contextGame.fillStyle = "#f9e531";
        if (GameController.currentMusicTimestamp >= 113.8)
          contextGame.fillStyle = "#ff2121";
        contextGame.fillRect(this.x, this.y, this.width + GameController.screenShakeX, this.height + GameController.screenShakeY);
        contextGame.font = "32px Arial";
        contextGame.fillStyle = "black";
        contextGame.textAlign = "center";
        contextGame.fillText(this.letter, this.x + 25 + GameController.screenShakeX, this.y + 36 + GameController.screenShakeY);
        contextGame.textAlign = "left";
      }
    }
    
    
    
    /// BlockStrip object (where the LetterBlocks must be to be destroyed)
    /// The dimensions are 600px x 50px
    
    var BlockStrip = {
      x : 0,
      y : canvasHeight-100,//canvas.height - 100,
      width : canvasWidth*2,
      height : 12,
      col : "white",
      
      update : function() {
        ///this.draw();
      },
        
      draw : function() {
        contextGame.fillStyle = this.col;
        contextGame.fillRect(this.x, this.y, this.width + GameController.screenShakeX, this.height + GameController.screenShakeY);
      },

      collision : function(otherY, otherHeight) {
        //if (otherY < this.y+this.height && otherY > this.y || otherY+otherHeight > this.y && otherY+otherHeight < this.y+this.height) {
          //console.log("true");
        if (otherY+otherHeight < this.y || otherY > this.y+this.height) {
          return false;
        } else {
          return true;
        }
      }
    } 
    
    
    function debugStats(context) {
      context.fillStyle = "white";
      context.font = "12px calibri";
      context.textAlign = "left";
      context.fillText("deltaTime : " + deltaTime, 5, 10);
      //context.fillText("randomBlockSpawnTime : " + GameController.randomBlockSpawnTime + "ms", 5, 20);
      context.fillText("mousePosition : " + mouseX + "," + mouseY, 5, 30);
      context.fillText("MouseLMB : " + Mouse.leftClick, 5, 40);
      context.fillText("currentMusicTimestamp : " + GameController.currentMusicTimestamp, 5, 50);
      context.fillText("musicTime : [" + musicTime[musicTimeIndex][0] + "][" + musicTime[musicTimeIndex][1] + "]", 5, 60);
      context.fillText("shakeTime : " + GameController.screenShakeTime, 5, 70);
      context.fillText("shakeX, shakeY : " + GameController.screenShakeX + "," + GameController.screenShakeY, 5, 80);
      context.fillText("gameIsPaused : " + gameIsPaused, 5, 90);
      //for (var i=0; i<26; i++)
      //contextGame.fillText(Letters[i] + " : " + Keyboard.Keys[i], 5, 40 + i * 10);
    }
    
    
    
    
  </script>
  <script src="guitargamemusic.js"></script>
</body>
</html>